<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Player de Músicas - Para Brenda</title>
    <style>
        :root{ --accent:#ff6b6b; --accent2:#d63384; --muted:#6c757d }
        *{box-sizing:border-box}
        html,body{height:100%; margin:0}
        body{font-family:Arial, Helvetica, sans-serif; background:linear-gradient(135deg,#ffecec,#fff7f8); display:flex; align-items:center; justify-content:center; padding:20px}
        .card{ width:100%; max-width:760px; background:#fff; border-radius:14px; box-shadow:0 18px 50px rgba(0,0,0,0.12); padding:18px; }
        .header{ display:flex; gap:12px; align-items:center }
        .back-btn{ background:transparent; border:0; color:var(--accent2); font-weight:700; cursor:pointer }
        h2{ margin:0; color:var(--accent2) }
        .player{ margin-top:14px; display:flex; flex-direction:column; gap:10px }
        .controls{ display:flex; gap:8px; align-items:center }
        .btn{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer }
        .btn.icon{ width:46px; height:46px; display:grid; place-items:center; padding:0 }
        .title{ font-weight:700; color:#333; }
        .sub{ color:var(--muted); font-size:0.92rem }
        .progress{ height:8px; background:rgba(0,0,0,0.06); border-radius:999px; overflow:hidden }
        .progress > i{ display:block; width:0%; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width 120ms linear }
        .files{ display:flex; gap:8px; align-items:center }
        .file-btn{ background:transparent; border:1px dashed rgba(0,0,0,0.06); padding:10px 12px; border-radius:10px; cursor:pointer }
        .playlist{ margin-top:10px; display:flex; flex-direction:column; gap:6px; max-height:280px; overflow:auto }
        .item{ display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:#fafafa; border:1px solid rgba(0,0,0,0.04) }
        .item .name{ font-weight:600 }
        .small{ font-size:0.86rem; color:var(--muted) }
        @media(max-width:520px){ .card{ padding:12px } .btn{ padding:8px 10px } .btn.icon{ width:40px;height:40px } }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <button class="back-btn" onclick="location.href='index.html'">← Voltar</button>
            <h2>Player de Músicas</h2>
        </div>

        <div class="player" role="region" aria-label="Player de música">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
                <div>
                    <div id="trackTitle" class="title">Nenhuma faixa</div>
                    <div id="trackSub" class="sub">Adicione faixas locais para montar uma playlist.</div>
                </div>
                <div class="controls">
                    <button id="prev" class="btn icon">❮</button>
                    <button id="play" class="btn icon">▶</button>
                    <button id="next" class="btn icon">❯</button>
                </div>
            </div>

            <div class="progress"><i id="bar"></i></div>

            <div class="files">
                        <input id="ytInput" placeholder="Cole link ou ID do YouTube" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
                        <button id="addBtn" class="file-btn">Adicionar YouTube</button>
                <div style="flex:1"></div>
                <div class="small" id="count">0 faixas</div>
            </div>

            <div class="playlist" id="playlist"></div>
                    <!-- hidden YouTube player (controls via API) -->
                    <div id="yt-player" style="display:none"></div>
        </div>
    </div>
        </script>
        <!-- YouTube IFrame API -->
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
        (() => {
            const addBtn = document.getElementById('addBtn');
            const ytInput = document.getElementById('ytInput');
            const playlistEl = document.getElementById('playlist');
            const titleEl = document.getElementById('trackTitle');
            const subEl = document.getElementById('trackSub');
            const bar = document.getElementById('bar');
            const count = document.getElementById('count');
            const playBtn = document.getElementById('play');
            const prevBtn = document.getElementById('prev');
            const nextBtn = document.getElementById('next');

            let playlist = JSON.parse(localStorage.getItem('ytPlaylist')||'[]');
            let idx = -1;
            let player = null;
            let progressTimer = null;

            function save(){ localStorage.setItem('ytPlaylist', JSON.stringify(playlist)); }

            function extractId(input){
                if(!input) return null;
                // common youtube id patterns
                const urlMatch = input.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
                if(urlMatch) return urlMatch[1];
                const shortMatch = input.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
                if(shortMatch) return shortMatch[1];
                const idMatch = input.match(/^([a-zA-Z0-9_-]{11})$/);
                if(idMatch) return idMatch[1];
                return null;
            }

            async function fetchTitle(videoId){
                try{
                    const url = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
                    const res = await fetch(url);
                    if(!res.ok) throw new Error('oembed failed');
                    const data = await res.json();
                    return data.title;
                }catch(e){ return 'Vídeo do YouTube'; }
            }

            function render(){
                playlistEl.innerHTML='';
                playlist.forEach((item,i)=>{
                    const el = document.createElement('div'); el.className='item';
                    const left = document.createElement('div'); left.style.flex='1';
                    const name = document.createElement('div'); name.className='name'; name.textContent = item.title || `Vídeo ${i+1}`;
                    const sub = document.createElement('div'); sub.className='small'; sub.textContent = item.id;
                    left.appendChild(name); left.appendChild(sub);

                    const right = document.createElement('div');
                    const play = document.createElement('button'); play.className='btn'; play.textContent='▶'; play.addEventListener('click', ()=> playIndex(i));
                    const rm = document.createElement('button'); rm.className='file-btn'; rm.textContent='✕'; rm.addEventListener('click', ()=> remove(i));
                    right.appendChild(play); right.appendChild(rm);

                    el.appendChild(left); el.appendChild(right);
                    playlistEl.appendChild(el);
                });
                count.textContent = playlist.length + ' faixas';
            }

            function remove(i){ if(i<0||i>=playlist.length) return; playlist.splice(i,1); if(i===idx){ if(playlist.length>0) playIndex(Math.max(0,i-1)); else { idx=-1; titleEl.textContent='Nenhuma faixa'; subEl.textContent='Adicione vídeos do YouTube'; if(player) player.stopVideo(); clearProgress(); } } else if(i<idx) idx--; save(); render(); }

            function onPlayerReady(){ /* nothing for now */ }

            function onPlayerStateChange(e){
                const YT = window.YT;
                if(!YT) return;
                if(e.data === YT.PlayerState.PLAYING){ playBtn.textContent='⏸'; startProgress(); subEl.textContent='Tocando'; }
                else if(e.data === YT.PlayerState.PAUSED){ playBtn.textContent='▶'; stopProgress(); subEl.textContent='Pausado'; }
                else if(e.data === YT.PlayerState.ENDED){ nextBtn.click(); }
            }

            function startProgress(){ stopProgress(); progressTimer = setInterval(()=>{
                    if(!player || typeof player.getCurrentTime !== 'function') return;
                    const cur = player.getCurrentTime(); const dur = player.getDuration() || 1;
                    const pct = Math.max(0, Math.min(100, (cur/dur)*100));
                    document.getElementById('bar').style.width = pct+'%';
                }, 250);
            }
            function stopProgress(){ if(progressTimer) { clearInterval(progressTimer); progressTimer=null; } }
            function clearProgress(){ document.getElementById('bar').style.width='0%'; stopProgress(); }

            function playIndex(i){ if(i<0||i>=playlist.length) return; idx=i; const id = playlist[i].id; titleEl.textContent = playlist[i].title || 'Carregando...'; subEl.textContent = 'Carregando vídeo...'; save(); if(player && player.loadVideoById){ player.loadVideoById(id); } else { /* will play once API ready */ }
            }

            // wire buttons
            playBtn.addEventListener('click', ()=>{
                if(!player) return;
                const state = player.getPlayerState();
                const YT = window.YT;
                if(state === YT.PlayerState.PLAYING) player.pauseVideo();
                else if(state === YT.PlayerState.PAUSED || state === YT.PlayerState.ENDED) player.playVideo();
                else if(idx===-1 && playlist.length>0) playIndex(0);
            });
            prevBtn.addEventListener('click', ()=>{ if(playlist.length>0) playIndex((idx-1+playlist.length)%playlist.length); });
            nextBtn.addEventListener('click', ()=>{ if(playlist.length>0) playIndex((idx+1)%playlist.length); });

            addBtn.addEventListener('click', async ()=>{
                const raw = ytInput.value.trim(); const vid = extractId(raw);
                if(!vid){ alert('Não consegui extrair um ID do YouTube a partir do texto informado. Cole o link completo ou o ID (11 caracteres).'); return; }
                const title = await fetchTitle(vid);
                playlist.push({ id: vid, title }); save(); render(); ytInput.value=''; if(idx===-1) playIndex(0);
            });

            // YouTube IFrame API setup
            window.onYouTubeIframeAPIReady = function(){
                player = new YT.Player('yt-player', {
                    height: '0', width: '0', videoId: playlist.length>0?playlist[0].id:'', events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
                });
                // if we restored a playlist and idx was -1, do not auto-start unless intended
                if(playlist.length>0){ idx=0; titleEl.textContent = playlist[0].title; subEl.textContent='Pronto'; }
            };

            // click on a playlist item to play (delegation)
            playlistEl.addEventListener('click', (e)=>{
                const btn = e.target.closest('button'); if(!btn) return; const items = Array.from(playlistEl.children); const idxClicked = items.indexOf(btn.closest('.item'));
                if(btn && btn.textContent==='▶') playIndex(idxClicked);
            });

            // initial render
            render();
            if(playlist.length>0){ titleEl.textContent = playlist[0].title; subEl.textContent='Pronto'; }

        })();
        </script>
</body>
</html>